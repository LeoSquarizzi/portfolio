---
// Dragon Easter Egg - Fullscreen Phaser CE rope animation
// Triggered by clicking the logo
// Uses CDN scripts to avoid bundling the large Phaser library
---

<!-- Fullscreen transparent overlay for dragon animation -->
<div id="dragon-overlay" class="dragon-overlay fixed inset-0 z-dragon hidden" aria-hidden="true">
  <ion-phaser-ce id="dragon-game"></ion-phaser-ce>
</div>

<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/phaser-ce/2.13.3/phaser.min.js"></script>
<script is:inline type="module" src="https://unpkg.com/@ion-phaser-ce/core@1.0.2/dist/ion-phaser-ce/ion-phaser-ce.esm.js"></script>
<script is:inline nomodule src="https://unpkg.com/@ion-phaser-ce/core@1.0.2/dist/ion-phaser-ce/ion-phaser-ce.js"></script>

<script is:inline>
  (function() {
    var overlay = document.getElementById('dragon-overlay');
    var ionPhaser = document.getElementById('dragon-game');
    var gameInstance = null;
    var isAnimating = false;
    var isInitialized = false;
    function createGameConfig() {
      return {
        width: '100%',
        height: '100%',
        transparent: true,
        renderer: Phaser.AUTO,
        roundPixels: true,
        alignH: true,
        alignV: true,
        scaleMode: Phaser.ScaleManager.RESIZE,
        disableVisibilityChange: true,
        state: {
          preload: function() {
            this.load.image('dragon', '/img/dragon.png');
            this.load.audio('roar', ['/audio/dragon.ogg', '/audio/dragon.mp3']);
          },
          create: function() {
            var points = [];
            var imgCache = this.game.cache.getFrame('dragon');
            var totalPoints = 26;
            var length = imgCache.width / totalPoints;

            for (var i = 0; i < totalPoints; i++) {
              points.push(new Phaser.Point(i * length, 0));
            }

            this.dragon = this.game.add.rope(
              -imgCache.width,
              this.game.scale.height / 2,
              'dragon',
              null,
              points
            );

            // Create and play sound immediately
            this.roarSound = this.game.add.audio('roar', 0.7);
            this.roarSound.play();

            this.dragon.aditionalInfo = {
              count: 0,
              finished: false
            };

            this.dragon.updateAnimation = function() {
              this.aditionalInfo.count += 0.1;
              for (var i = 0; i < this.points.length; i++) {
                this.points[i].y = Math.sin(i * 0.3 + this.aditionalInfo.count) * 10;
              }
            };
          },
          update: function() {
            if (!this.dragon) return;

            // Use game.scale for actual viewport size (not world size)
            var viewportWidth = this.game.scale.width;
            var viewportHeight = this.game.scale.height;

            this.dragon.updateAnimation();
            this.dragon.x += 8;
            this.dragon.y = viewportHeight / 2;

            if (!this.dragon.aditionalInfo.finished && this.dragon.x > viewportWidth) {
              this.dragon.aditionalInfo.finished = true;
              hideOverlay();
            }
          }
        }
      };
    }

    function hideOverlay() {
      overlay.classList.add('hidden');
      overlay.setAttribute('aria-hidden', 'true');
      // Pause the game instead of destroying it
      if (gameInstance) {
        gameInstance.paused = true;
      }
      isAnimating = false;
    }

    function triggerDragon() {
      if (isAnimating || typeof Phaser === 'undefined') return;

      isAnimating = true;
      overlay.classList.remove('hidden');
      overlay.setAttribute('aria-hidden', 'false');

      // Trigger ninja animation too
      window.dispatchEvent(new CustomEvent('dragon-triggered'));

      if (isInitialized && gameInstance) {
        // Resume and restart the state
        gameInstance.paused = false;
        gameInstance.state.restart(true, false);
      } else {
        // First time: initialize the game
        customElements.whenDefined('ion-phaser-ce').then(function() {
          ionPhaser.game = createGameConfig();
          ionPhaser.getInstance().then(function(game) {
            gameInstance = game;
            isInitialized = true;
          }).catch(function(error) {
            console.error('Dragon game error:', error);
            hideOverlay();
          });
        });
      }
    }

    // Listen for logo clicks
    function init() {
      var logoTrigger = document.querySelector('[data-dragon-trigger]');
      if (logoTrigger) {
        logoTrigger.addEventListener('click', function(e) {
          if (!isAnimating) {
            e.preventDefault();
            triggerDragon();
          }
        });
      }
    }

    // Initialize when ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

<style>
  .dragon-overlay {
    z-index: 9999;
    background: transparent;
    pointer-events: none;
  }

  .dragon-overlay ion-phaser-ce {
    width: 100%;
    height: 100%;
    display: block;
  }

  .dragon-overlay ion-phaser-ce canvas {
    background: transparent !important;
  }
</style>
